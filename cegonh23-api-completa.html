<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Base Local com Exporta√ß√£o (IndexedDB + M√≠dia)</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
  h2 { margin-top: 0; }
  button, input[type=file] { padding: 6px 10px; margin: 3px; }
  textarea { width: 100%; height: 200px; font-family: monospace; margin-top: 10px; resize: vertical; }
  #fileList { margin-top: 10px; background: #fff; padding: 10px; border: 1px solid #ccc; }
  .file-item { padding: 6px 0; border-bottom: 1px solid #eee; }
  #mediaPreview { margin-top: 15px; background: #fff; padding: 10px; border: 1px solid #ccc; text-align: center; }
  iframe, video, img { max-width: 100%; margin-top: 10px; }
</style>
</head>
<body>

<h2>üì¶ Mini Banco Local (IndexedDB) + M√≠dia</h2>

<div>
  <input type="file" id="fileInput" multiple>
  <button id="importBtn">üì§ Importar</button>
  <button id="exportAllBtn">üì¶ Exportar Base (.zip)</button>
  <button id="clearBtn">üóëÔ∏è Limpar Todos</button>
</div>

<div id="fileList">Carregando arquivos...</div>

<div id="mediaPreview">
  <h3>üé¨ Pr√©-visualiza√ß√£o</h3>
  <div id="previewContent"><i>Nenhuma m√≠dia selecionada.</i></div>
</div>

<h3>üìù Editor de Texto</h3>
<div>
  <button id="saveLocal">üíæ Salvar no localStorage</button>
  <button id="loadLocal">üìÇ Carregar</button>
  <button id="exportTxt">‚¨áÔ∏è Exportar Texto</button>
</div>
<textarea id="editor" placeholder="Digite ou carregue texto aqui..."></textarea>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
let db;
const dbName = "MiniFileDB";
const storeName = "files";
const STORAGE_KEY = "texto_local";
const editor = document.getElementById("editor");

// === IndexedDB ===
function initDB() {
  const req = indexedDB.open(dbName, 1);
  req.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore(storeName, { keyPath: "id", autoIncrement: true });
  };
  req.onsuccess = e => { db = e.target.result; listFiles(); };
  req.onerror = e => alert("Erro ao abrir banco: " + e.target.errorCode);
}

// === Banco ===
function addFile(file, buffer) {
  const tx = db.transaction([storeName], "readwrite");
  const store = tx.objectStore(storeName);
  let textContent = null;
  try {
    textContent = new TextDecoder("utf-8").decode(buffer);
    if ((textContent.match(/\0/g) || []).length > textContent.length * 0.02) textContent = null;
  } catch {}
  store.add({
    name: file.name,
    type: file.type,
    size: file.size,
    data: buffer,
    textContent,
    created: new Date().toISOString()
  }).onsuccess = listFiles;
}

function listFiles() {
  const tx = db.transaction([storeName], "readonly");
  const store = tx.objectStore(storeName);
  store.getAll().onsuccess = e => {
    const files = e.target.result;
    const div = document.getElementById("fileList");
    if (!files.length) return div.innerHTML = "<i>Nenhum arquivo salvo.</i>";
    div.innerHTML = "";
    files.forEach(f => {
      const el = document.createElement("div");
      el.className = "file-item";
      el.innerHTML = `
        <b>${f.name}</b> (${(f.size/1024).toFixed(1)} KB)
        <button onclick="openFile(${f.id})">Abrir</button>
        <button onclick="previewMedia(${f.id})">Ver</button>
        <button onclick="downloadFile(${f.id})">Baixar</button>
        <button onclick="deleteFile(${f.id})">Excluir</button>
      `;
      div.appendChild(el);
    });
  };
}

// === Abertura de texto ===
function openFile(id) {
  const tx = db.transaction([storeName], "readonly");
  tx.objectStore(storeName).get(id).onsuccess = e => {
    const f = e.target.result;
    if (!f) return alert("Arquivo n√£o encontrado!");
    editor.value = f.textContent || "[Arquivo bin√°rio - n√£o exib√≠vel]";
  };
}

// === Pr√©-visualizar imagens e v√≠deos ===
function previewMedia(id) {
  const preview = document.getElementById("previewContent");
  const tx = db.transaction([storeName], "readonly");
  tx.objectStore(storeName).get(id).onsuccess = e => {
    const f = e.target.result;
    if (!f) return alert("Arquivo n√£o encontrado!");

    preview.innerHTML = "";
    const blob = new Blob([f.data], { type: f.type });
    const url = URL.createObjectURL(blob);

    if (f.type.startsWith("image/")) {
      const img = document.createElement("img");
      img.src = url;
      preview.appendChild(img);
    } 
    else if (f.type.startsWith("video/")) {
      const vid = document.createElement("video");
      vid.controls = true;
      vid.src = url;
      preview.appendChild(vid);
    } 
    else {
      preview.innerHTML = `<i>Tipo n√£o suportado: ${f.type}</i>`;
    }
  };
}

// === Suporte a v√≠deos do YouTube ===
function playYouTubeVideo(url) {
  const preview = document.getElementById("previewContent");
  const idMatch = url.match(/(?:v=|youtu\.be\/)([^&]+)/);
  if (!idMatch) return alert("URL do YouTube inv√°lida!");
  const videoId = idMatch[1];
  preview.innerHTML = `
    <iframe width="560" height="315"
      src="https://www.youtube.com/embed/${videoId}"
      title="YouTube video"
      frameborder="0"
      allowfullscreen></iframe>`;
}

// Bot√£o r√°pido para testar YouTube
const ytButton = document.createElement("button");
ytButton.textContent = "üé• Tocar YouTube";
ytButton.onclick = () => {
  const url = prompt("Cole o link do v√≠deo do YouTube:");
  if (url) playYouTubeVideo(url);
};
document.getElementById("mediaPreview").prepend(ytButton);

// === Download ===
function downloadFile(id) {
  const tx = db.transaction([storeName], "readonly");
  tx.objectStore(storeName).get(id).onsuccess = e => {
    const f = e.target.result;
    const blob = new Blob([f.data], { type: f.type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = f.name; a.click();
    URL.revokeObjectURL(url);
  };
}

// === Excluir ===
function deleteFile(id) {
  if (!confirm("Excluir este arquivo?")) return;
  const tx = db.transaction([storeName], "readwrite");
  tx.objectStore(storeName).delete(id).onsuccess = listFiles;
}

// === Limpar tudo ===
document.getElementById("clearBtn").onclick = () => {
  if (!confirm("Apagar todos os arquivos?")) return;
  db.transaction([storeName], "readwrite").objectStore(storeName).clear().onsuccess = listFiles;
};

// === Importa√ß√£o ===
document.getElementById("importBtn").onclick = async () => {
  const input = document.getElementById("fileInput");
  const files = input.files;
  if (!files.length) return alert("Escolha ao menos um arquivo!");
  for (const file of files) {
    const buffer = await file.arrayBuffer();
    addFile(file, buffer);
  }
  alert("Importa√ß√£o conclu√≠da!");
};

// === Exportar todos ===
document.getElementById("exportAllBtn").onclick = async () => {
  const zip = new JSZip();
  const tx = db.transaction([storeName], "readonly");
  const store = tx.objectStore(storeName);
  const req = store.getAll();
  req.onsuccess = async e => {
    const files = e.target.result;
    if (!files.length) return alert("Nenhum arquivo para exportar.");
    files.forEach(f => zip.file(f.name, f.data));
    const blob = await zip.generateAsync({ type: "blob" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "backup_base.zip"; a.click();
    URL.revokeObjectURL(url);
  };
};

// === LocalStorage ===
document.getElementById("saveLocal").onclick = () => {
  localStorage.setItem(STORAGE_KEY, editor.value);
  alert("Texto salvo!");
};
document.getElementById("loadLocal").onclick = () => {
  const val = localStorage.getItem(STORAGE_KEY);
  if (!val) return alert("Nada salvo.");
  editor.value = val;
};
document.getElementById("exportTxt").onclick = () => {
  const blob = new Blob([editor.value], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "texto.txt"; a.click();
  URL.revokeObjectURL(url);
};

// === Inicializa√ß√£o ===
initDB();
</script>
</body>
</html>
